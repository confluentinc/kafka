version: v1.0
name: create-zk-image
agent:
  machine:
    type: s1-prod-ubuntu20-04-amd64-1
blocks:
  - name: "Build, Release ZK image"
    task:
      prologue:
        commands:
          - echo $SEMAPHORE_WORKFLOW_ID
          - checkout
          - . vault-setup
          - . vault-sem-get-secret testbreak-reporting
          - . vault-sem-get-secret ci-reporting
          - . vault-sem-get-secret cpd_gcloud
          - . vault-sem-get-secret gradle_properties
          - . vault-sem-get-secret sox-semaphore-build-info
          - make init-ci
          - sem-version java 17
          - sem-version go 1.16.15
          - git config --global url."git@github.com:".insteadOf "https://github.com/"
          - export SEMAPHORE_CACHE_DIR=/home/semaphore
          - make testbreak-setup
          - make show-version
      jobs:
        - name: "Build, Release ZK image"
          commands:
            - make init-ci
            - DOCKER_BUILDKIT=1 make build-docker-cc-zookeeper
            - make push-docker-cc-zookeeper
            - make sox-log-docker-sha-cc-zookeeper
      epilogue:
        commands:
          - make testbreak-after
