version: v1.0
name: create-trogdor-image
agent:
  machine:
    type: s1-prod-ubuntu20-04-amd64-1
blocks:
  - name: "Build, Release Trogdor image"
    task:
      prologue:
        commands:
          - echo $SEMAPHORE_WORKFLOW_ID
          - checkout
          - . vault-setup
          - . vault-sem-get-secret testbreak-reporting
          - . vault-sem-get-secret ci-reporting
          - . vault-sem-get-secret cpd_gcloud
          - . vault-sem-get-secret gradle_properties
          - . vault-sem-get-secret sox-semaphore-build-info
          - sem-version java 17
          - sem-version go 1.16.15
          - git config --global url."git@github.com:".insteadOf "https://github.com/"
          - export SEMAPHORE_CACHE_DIR=/home/semaphore
          - make testbreak-setup
          - make show-version
      jobs:
        - name: "Build, Release Trogdor image"
          commands:
            - PUSH_DOCKER_OVERRIDE=push-docker-version-to-release DOCKER_REPO=519856050701.dkr.ecr.us-west-2.amazonaws.com/docker/prod make -C cc-services/trogdor build-docker push-docker sign-image
      epilogue:
        commands:
          - make testbreak-after
